---
import Layout from '../layouts/Layout.astro';
import MeshBuilderPanel from '../components/MeshBuilderPanel';
---

<Layout title="Live Map">
  <div class="h-screen flex flex-col">
    <!-- Map Warning Banner (shown if config is missing) -->
    <div id="map-warning" class="hidden alert alert-warning">
      <svg class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <span>Map tiles may not load properly. API tokens are missing or invalid.</span>
    </div>

    <!-- Map Container -->
    <div id="map" class="flex-1 relative"></div>

    <!-- Control Panel -->
    <div id="control-panel" class="fixed top-20 left-4 z-[1000] card bg-base-200 shadow-xl w-80 max-h-[calc(100vh-6rem)] overflow-y-auto">
      <div class="card-body p-4">
        <h3 class="card-title text-lg">Map Controls</h3>
        <div class="space-y-2">
          <button id="toggle-weather" class="btn btn-sm btn-outline w-full">
            Toggle Weather Radar
          </button>
          <button id="toggle-utilities" class="btn btn-sm btn-outline w-full">
            Toggle Utilities Grid
          </button>
          <button id="refresh-hurricanes" class="btn btn-sm btn-outline w-full">
            <span id="hurricane-count">Refresh Hurricane Data</span>
          </button>
          <button id="refresh-alerts" class="btn btn-sm btn-outline w-full">
            <span id="alert-count">Refresh Weather Alerts</span>
          </button>
          <div class="divider my-1"></div>
          <input
            type="text"
            id="address-input"
            placeholder="Enter address..."
            class="input input-sm input-bordered w-full"
          />
          <button id="route-to-shelter" class="btn btn-sm btn-primary w-full">
            Find Nearest Shelter
          </button>
          <div class="divider my-1"></div>
          <button id="toggle-mesh-builder" class="btn btn-sm btn-accent w-full">
            Toggle Mesh Builder
          </button>
        </div>
      </div>
    </div>

    <!-- Mesh Builder Panel -->
    <div id="mesh-builder-panel" class="fixed top-20 left-[22rem] z-[1000] hidden">
      <div id="mesh-builder-root"></div>
    </div>

    <!-- Sidebar for ASCOPE reports -->
    <div id="sidebar" class="fixed right-0 top-20 z-[1000] card bg-base-200 shadow-xl w-96 max-h-[calc(100vh-6rem)] overflow-y-auto transform translate-x-full transition-transform duration-300">
      <div class="card-body p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="card-title text-lg">Location Details</h3>
          <button id="close-sidebar" class="btn btn-sm btn-circle btn-ghost">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div id="sidebar-content">
          <!-- Content will be inserted by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Dashboard Widgets -->
    <div id="dashboard-widgets" class="fixed bottom-4 right-4 z-[999] space-y-4 w-80">
      <!-- SDR Widget -->
      <div class="card bg-base-200 shadow-xl">
        <div class="card-body p-3">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-bold text-sm">Radio Monitor</h4>
            <span class="badge badge-success badge-xs">Monitoring</span>
          </div>
          <div id="sdr-messages" class="text-xs space-y-1 max-h-32 overflow-y-auto">
            <div class="text-base-content/50">Loading radio data...</div>
          </div>
        </div>
      </div>

      <!-- SITREP Widget -->
      <div class="card bg-base-200 shadow-xl">
        <div class="card-body p-3">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-bold text-sm">SITREP Feed</h4>
            <span class="badge badge-info badge-xs">Active</span>
          </div>
          <div id="sitrep-messages" class="text-xs space-y-1 max-h-32 overflow-y-auto">
            <div class="text-base-content/50">Loading situation reports...</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load Leaflet -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Load legacy map assets -->
  <script is:inline>
    // Check for config and show warning if needed
    fetch('/PR-CYBR-MAP/data/config.json')
      .catch(() => {
        const warning = document.getElementById('map-warning');
        if (warning) {
          warning.classList.remove('hidden');
        }
      });
  </script>
  
  <!-- Import map modules -->
  <script is:inline>
    // We'll load the legacy map scripts
    // For now, initialize a basic map
    document.addEventListener('DOMContentLoaded', function() {
      // @ts-ignore - Leaflet is loaded globally
      const map = L.map('map').setView([18.2208, -66.5901], 8);
      
      // Try to load config for API token
      fetch('/PR-CYBR-MAP/data/config.json')
        .then(res => res.json())
        .then(config => {
          const token = config.JAWG_ACCESS_TOKEN || config.MAPBOX_ACCESS_TOKEN;
          if (token && config.JAWG_ACCESS_TOKEN) {
            // @ts-ignore
            L.tileLayer(`https://tile.jawg.io/jawg-matrix/{z}/{x}/{y}{r}.png?access-token=${token}`, {
              attribution: '<a href="https://jawg.io">© Jawg</a> <a href="https://www.openstreetmap.org/copyright">© OpenStreetMap</a>',
              minZoom: 0,
              maxZoom: 22
            }).addTo(map);
          } else {
            // Fallback to OSM
            // @ts-ignore
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '© OpenStreetMap contributors'
            }).addTo(map);
          }
        })
        .catch(() => {
          // Fallback to OSM if config fails
          // @ts-ignore
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
          }).addTo(map);
        });
      
      // Load marker data
      fetch('/PR-CYBR-MAP/data/cache/PR-CYBR-MAP.json')
        .then(res => res.json())
        .then(data => {
          // Add markers
          data.forEach(location => {
            if (location.lat && location.lng) {
              // @ts-ignore
              L.marker([location.lat, location.lng])
                .addTo(map)
                .bindPopup(`<b>${location.name || 'Location'}</b>`);
            }
          });
        })
        .catch(err => console.error('Error loading markers:', err));
      
      // Simple control panel handlers
      document.getElementById('close-sidebar')?.addEventListener('click', () => {
        document.getElementById('sidebar')?.classList.add('translate-x-full');
      });
      
      // Placeholder messages for widgets
      setTimeout(() => {
        const sdrEl = document.getElementById('sdr-messages');
        if (sdrEl) {
          sdrEl.innerHTML = '<div class="opacity-70">No active radio transmissions</div>';
        }
        
        const sitrepEl = document.getElementById('sitrep-messages');
        if (sitrepEl) {
          sitrepEl.innerHTML = '<div class="opacity-70">No new situation reports</div>';
        }
      }, 2000);
      
      // Mesh Builder integration
      let meshLayers = null;
      let meshBuilderVisible = false;
      
      // Toggle mesh builder panel
      document.getElementById('toggle-mesh-builder')?.addEventListener('click', () => {
        const panel = document.getElementById('mesh-builder-panel');
        if (panel) {
          meshBuilderVisible = !meshBuilderVisible;
          if (meshBuilderVisible) {
            panel.classList.remove('hidden');
            // Initialize mesh layers if not already done
            if (!meshLayers && window.L) {
              try {
                // Dynamically import and initialize mesh layers
                import('/PR-CYBR-MAP/_astro/hoisted.BdpDw26L.js').then(() => {
                  console.log('Mesh layers would be initialized here');
                  // TODO: Initialize MeshMapLayers when fully integrated
                }).catch(() => {
                  console.log('Mesh integration pending');
                });
              } catch (e) {
                console.log('Mesh layers initialization deferred');
              }
            }
          } else {
            panel.classList.add('hidden');
          }
        }
      });
    });
  </script>
  
  <!-- Mesh Builder React Component Integration -->
  <script>
    // This will be enhanced later to properly mount the React component
    // For now, we show a placeholder
    document.addEventListener('DOMContentLoaded', () => {
      const root = document.getElementById('mesh-builder-root');
      if (root) {
        root.innerHTML = `
          <div class="card bg-base-200 shadow-xl w-80">
            <div class="card-body p-4">
              <h3 class="card-title text-lg">M3SH Builder</h3>
              <p class="text-sm opacity-70">Mesh network builder coming soon...</p>
              <div class="space-y-2 mt-4">
                <div class="alert alert-info p-2 text-xs">
                  <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>Click map to place nodes. Right-click to remove.</span>
                </div>
                <button class="btn btn-sm btn-outline w-full" disabled>Place Node</button>
                <button class="btn btn-sm btn-outline w-full" disabled>Draw Links</button>
                <button class="btn btn-sm btn-primary w-full" disabled>Deploy-M3SH</button>
                <button class="btn btn-sm btn-outline w-full" disabled>Compute LOS</button>
              </div>
            </div>
          </div>
        `;
      }
    });
  </script>
</Layout>

<style>
  #map {
    @apply w-full h-full;
  }
  
  .leaflet-container {
    @apply z-0;
  }
</style>
